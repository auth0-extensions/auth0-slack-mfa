module.exports=function(e){function t(r){if(n[r])return n[r].exports;var o=n[r]={exports:{},id:r,loaded:!1};return e[r].call(o.exports,o,o.exports,t),o.loaded=!0,o.exports}var n={};return t.m=e,t.c=n,t.p="",t(0)}([function(e,t,n){"use strict";var r=n(15),o=n(8),u=n(16),a=n(1),i=n(3),s=n(19);o.urlHelpers.getBaseUrl=function(e){var t=r.parse(e.originalUrl||"").pathname||"";return r.format({protocol:"https",host:e.headers.host,pathname:t.replace(e.path,"").replace(/\/$/g,"")})};var c=o.createServer(function(e,t){return i.info("Starting Slack MFA Extension - Version:","1.0.1"),u(e,t)});e.exports=function(e,t,n){a.setValue("PUBLIC_WT_URL",s.getUrl(t)),c(e,t,n)}},function(e,t){"use strict";var n={},r=null,o=function(e){if(n&&n[e])return n[e];if(!r)throw new Error("A configuration provider has not been set");return r(e)};o.setProvider=function(e){r=e},o.setValue=function(e,t){n[e]=t},e.exports=o},function(e,t){e.exports=require("express")},function(e,t,n){"use strict";var r=n(57);r.emitErrs=!0;var o=new r.Logger({transports:[new r.transports.Console({timestamp:!0,level:"debug",handleExceptions:!0,json:!1,colorize:!0})],exitOnError:!1});e.exports=o,e.exports.stream={write:function(e){o.info(e.replace(/\n$/,""))}}},function(e,t,n){e.exports=!n(5)(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a})},function(e,t){e.exports=function(e){try{return!!e()}catch(e){return!0}}},function(e,t){var n=e.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=n)},function(e,t){e.exports=function(e){return"object"==typeof e?null!==e:"function"==typeof e}},function(e,t){e.exports=require("auth0-extension-express-tools@1.0.1")},function(e,t){var n=e.exports={version:"2.4.0"};"number"==typeof __e&&(__e=n)},function(e,t){e.exports=function(e){if(void 0==e)throw TypeError("Can't call method on  "+e);return e}},function(e,t,n){var r=n(30);e.exports=Object("z").propertyIsEnumerable(0)?Object:function(e){return"String"==r(e)?e.split(""):Object(e)}},function(e,t){var n=Math.ceil,r=Math.floor;e.exports=function(e){return isNaN(e=+e)?0:(e>0?r:n)(e)}},function(e,t,n){var r=n(11),o=n(10);e.exports=function(e){return r(o(e))}},function(e,t){e.exports=require("ejs")},function(e,t){e.exports=require("url")},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}var o=n(56),u=r(o),a=n(2),i=r(a),s=n(54),c=r(s),l=n(8),f=n(3),d=r(f),p=n(1),h=r(p),m=n(22),x=r(m),_=n(20),v=r(_),g=n(21),b=r(g);e.exports=function(e){h.default.setProvider(e);var t=new i.default;return t.use((0,u.default)(":method :url :status :response-time ms - :res[content-length]",{stream:d.default.stream})),t.use(c.default.json()),t.use(c.default.urlencoded({extended:!1})),t.use(l.routes.dashboardAdmins({stateKey:"slack-mfa-state",secret:(0,h.default)("EXTENSION_SECRET"),audience:"urn:slack-mfa",rta:(0,h.default)("AUTH0_RTA").replace("https://",""),domain:(0,h.default)("AUTH0_DOMAIN"),baseUrl:(0,h.default)("PUBLIC_WT_URL"),clientName:"Slack MFA Extension",urlPrefix:"/admins",sessionStorageKey:"slack-mfa:apiToken",scopes:"read:clients read:resource_servers"})),t.use("/meta",(0,x.default)()),t.use("/.extensions",(0,v.default)()),t.use("/app",[cancel,enroll,mfa,verify]),t.use("*",(0,b.default)()),t.use(l.middlewares.errorHandler(d.default.error)),t}},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0});var o=n(14),u=r(o),a=n(1),i=r(a),s=n(18),c=r(s);t.default=function(){return u.default.render(c.default,{extensionUrl:(0,i.default)("PUBLIC_WT_URL").replace(/\/$/g,""),apiKey:(0,i.default)("EXTENSION_SECRET"),updateTime:function(){return(new Date).toISOString()},SLACK_API_TOKEN:(0,i.default)("SLACK_API_TOKEN"),SIGINING_SECRET:(0,i.default)("SIGNING_SECRET"),MONGO_CONNECTION_STRINGT:(0,i.default)("MONGO_CONNECTION_STRING")})}},function(e,t){"use strict";e.exports="/*\n*  This rule been automatically generated by the auth0-slack-mfa extension on <%= updateTime() %>\n*/\nfunction (user, context, callback) {\n  var jwt = require('jsonwebtoken');\n  var MongoClient = require('mongodb');\n  var CLIENTS_WITH_MFA = ['ZxbatHjRgBj9xFZ1SyygKZDhkb4r17Vk'];\n\n  // run only for the specified clients\n  if (CLIENTS_WITH_MFA.indexOf(context.clientID) === -1) {\n    return callback(null,user,context);\n  }\n\n  // returning from MFA validation\n  if(context.protocol === 'redirect-callback') {\n    var decoded = jwt.verify(context.request.query.token, new Buffer(configuration.slack_mfa_secret, 'base64'));\n    if (!decoded || decoded.iss !== 'urn:sgmeyer:slack:mfacallback') return callback(new Error('Invalid Token'));\n\n    MongoClient = require('mongodb').MongoClient;\n    MongoClient.connect(configuration.mongo_connection, function(err, db) {\n      var collection = db.collection('Token');\n\n      var filter = { \"jti\": decoded.jti };\n      collection.findOne(filter, function (err, whitelist) {\n        if (!whitelist) return callback(new Error('Invalid JWT ID'));\n\n        collection.remove(filter, function (err) {\n          if (err) throw new Error('Failed to revoke token');\n          return callback(null,user,context);\n        });\n      });\n    });\n\n    return callback(null,user,context);\n  } else {\n\n    var uuid = require('uuid');\n    var token_payload = {\n      sub: user.user_id,\n      aud: context.clientID,\n      jti: uuid.v4(),\n      iat: new Date().getTime() / 1000,\n      iss: 'urn:sgmeyer:slack:mfa'\n    };\n\n    if (user.user_metadata) {\n      token_payload.slack_username = user.user_metadata.slack_mfa_username;\n      token_payload.slack_enrolled = user.user_metadata.slack_mfa_enrolled;\n    }\n\n    var token = jwt.sign(token_payload,\n      new Buffer(configuration.slack_mfa_secret, 'base64'),\n      {\n        subject: user.user_id,\n        expiresInMinutes: 5,\n        audience: context.clientID,\n        issuer: 'urn:sgmeyer:slack:mfa',\n        iat: new Date().getTime() / 1000\n      });\n\n    MongoClient = require('mongodb').MongoClient;\n    MongoClient.connect(configuration.mongo_connection, function (err, db) {\n      var tokenRecord = {\n        jti: token_payload.jti,\n        sub: token_payload.sub,\n        iss: token_payload.iss,\n        issued: new Date(token_payload.iat * 1000)\n      };\n\n      var upsertFilter = { 'sub': token_payload.sub, 'iss': token_payload.iss };\n      return db.collection('Token').update(upsertFilter, tokenRecord, { upsert: true }, function (err, record) {\n        if (err) { throw new Error('Failed to whitelist JWT.'); }\n\n      var route = user.user_metadata && user.user_metadata.slack_mfa_username ? \"/mfa\" : \"/enroll\";\n        context.redirect = { url: configuration.slack_mfa_url + route + '?token=' + token };\n        return callback(null, user, context);\n      });\n    });\n  }\n}"},function(e,t,n){"use strict";function r(e){if(!e.container)return null;var t=e.container.replace(s,"\\$&"),n=e.jtn?e.jtn.replace(s,"\\$&"):"";if(e.url_format===i)return new RegExp("^/api/run/"+t+"/(?:"+n+"/?)?");if(e.url_format===a)return new RegExp("^/"+t+"/(?:"+n+"/?)?");if(e.url_format===u)return new RegExp("^/(?:"+n+"/?)?");throw new Error("Unsupported webtask URL format.")}var o=n(15),u=3,a=2,i=1,s=/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g;e.exports.getUrl=function(e){var t=r(e.x_wt),n=e.url,u=e.url.replace(t,"/"),a=o.parse(u||"").pathname,i=o.parse(n||"").pathname||"",s=o.format({protocol:"https",host:e.headers.host,pathname:i.replace(a,"").replace(/\/$/g,"")});return e.x_wt&&(0===s.indexOf("https://sandbox.it.auth0.com")?s=s.replace("https://sandbox.it.auth0.com/api/run/"+e.x_wt.container+"/","https://"+e.x_wt.container+".us.webtask.io/"):0===s.indexOf("https://sandbox-eu.it.auth0.com")?s=s.replace("https://sandbox-eu.it.auth0.com/api/run/"+e.x_wt.container+"/","https://"+e.x_wt.container+".eu.webtask.io/"):0===s.indexOf("https://sandbox-au.it.auth0.com")&&(s=s.replace("https://sandbox-au.it.auth0.com/api/run/"+e.x_wt.container+"/","https://"+e.x_wt.container+".au.webtask.io/"))),s}},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0});var o=n(25),u=r(o),a=n(55),i=r(a),s=n(2),c=n(8),l=n(1),f=r(l),d=n(3),p=r(d),h=n(17),m=r(h);t.default=function(){var e=(0,s.Router)(),t=c.middlewares.validateHookToken((0,f.default)("AUTH0_DOMAIN"),(0,f.default)("WT_URL"),(0,f.default)("EXTENSION_SECRET"));return e.use("/on-install",t("/.extensions/on-install")),e.use("/on-uninstall",t("/.extensions/on-uninstall")),e.use(c.middlewares.managementApiClient({domain:(0,f.default)("AUTH0_DOMAIN"),clientId:(0,f.default)("AUTH0_CLIENT_ID"),clientSecret:(0,f.default)("AUTH0_CLIENT_SECRET")})),e.post("/on-install",function(e,t){var n="auth0-slack-mfa";e.auth0.rules.getAll().then(function(t){var r={name:n,script:(0,m.default)(f.default,n)},o=i.default.find(t,{name:n});return o?e.auth0.rules.update({id:o.id},r):e.auth0.rules.create((0,u.default)({stage:"login_success"},r))}).then(function(){p.default.debug("Slack MFA rule deployed."),t.sendStatus(204)}).catch(function(e){p.default.debug("Error deploying Slack MFA rule."),p.default.error(e),t.sendStatus(400)})}),e.delete("/on-uninstall",function(e,t){var n="auth0-slack-mfa";e.auth0.rules.getAll().then(function(t){var r=i.default.find(t,{name:n});r&&e.auth0.rules.delete({id:r.id})}).then(function(){p.default.debug("Slack MFA rule deleted."),t.sendStatus(204)}).catch(function(e){p.default.debug("Error deleting Slack MFA rule."),p.default.error(e),t.sendStatus(204)})}),e}},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0});var o=n(14),u=r(o),a=(n(2),n(23)),i=r(a);t.default=function(){return console.log("hereo."),function(e,t){return console.log("here"),t.end(u.default.render((0,i.default)()))}}},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0});var o=n(2),u=r(o),a=n(53),i=r(a);t.default=function(){var e=u.default.Router();return e.get("/",function(e,t){t.status(200).send(i.default)}),e}},function(e,t){"use strict";function n(){return'\n  <!DOCTYPE html>\n  <html lang="en">\n  <head>\n    <title>Auth0 - Slack MFA</title>\n    <meta charset="UTF-8" />\n    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />\n    <meta name="viewport" content="width=device-width, initial-scale=1.0" />\n    <link rel="shortcut icon" href="https://cdn.auth0.com/styleguide/4.6.13/lib/logos/img/favicon.png">\n    <meta name="viewport" content="width=device-width, initial-scale=1">\n    <link rel="stylesheet" type="text/css" href="https://cdn.auth0.com/styles/zocial.min.css">\n    <link rel="stylesheet" type="text/css" href="https://cdn.auth0.com/manage/v0.3.1715/css/index.min.css">\n    <link rel="stylesheet" type="text/css" href="https://cdn.auth0.com/styleguide/4.6.13/index.css">\n    <style type="text/css">\n    pre {\n      background-color: #fbfbfb;\n      border: 1px solid #f1f1f1;\n      border-radius: 0px;\n      padding: 10px 10px;\n      font-size: 12px;\n    }\n    </style>\n  </head>\n  <body>\n    Hello, friend.\n  </body>\n  </html>\n  '}e.exports=n},function(e,t,n){e.exports={default:n(26),__esModule:!0}},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}t.__esModule=!0;var o=n(24),u=r(o);t.default=u.default||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e}},function(e,t,n){n(52),e.exports=n(9).Object.assign},function(e,t){e.exports=function(e){if("function"!=typeof e)throw TypeError(e+" is not a function!");return e}},function(e,t,n){var r=n(7);e.exports=function(e){if(!r(e))throw TypeError(e+" is not an object!");return e}},function(e,t,n){var r=n(13),o=n(48),u=n(47);e.exports=function(e){return function(t,n,a){var i,s=r(t),c=o(s.length),l=u(a,c);if(e&&n!=n){for(;c>l;)if(i=s[l++],i!=i)return!0}else for(;c>l;l++)if((e||l in s)&&s[l]===n)return e||l||0;return!e&&-1}}},function(e,t){var n={}.toString;e.exports=function(e){return n.call(e).slice(8,-1)}},function(e,t,n){var r=n(27);e.exports=function(e,t,n){if(r(e),void 0===t)return e;switch(n){case 1:return function(n){return e.call(t,n)};case 2:return function(n,r){return e.call(t,n,r)};case 3:return function(n,r,o){return e.call(t,n,r,o)}}return function(){return e.apply(t,arguments)}}},function(e,t,n){var r=n(7),o=n(6).document,u=r(o)&&r(o.createElement);e.exports=function(e){return u?o.createElement(e):{}}},function(e,t){e.exports="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(",")},function(e,t,n){var r=n(6),o=n(9),u=n(31),a=n(36),i="prototype",s=function(e,t,n){var c,l,f,d=e&s.F,p=e&s.G,h=e&s.S,m=e&s.P,x=e&s.B,_=e&s.W,v=p?o:o[t]||(o[t]={}),g=v[i],b=p?r:h?r[t]:(r[t]||{})[i];p&&(n=t);for(c in n)l=!d&&b&&void 0!==b[c],l&&c in v||(f=l?b[c]:n[c],v[c]=p&&"function"!=typeof b[c]?n[c]:x&&l?u(f,r):_&&b[c]==f?function(e){var t=function(t,n,r){if(this instanceof e){switch(arguments.length){case 0:return new e;case 1:return new e(t);case 2:return new e(t,n)}return new e(t,n,r)}return e.apply(this,arguments)};return t[i]=e[i],t}(f):m&&"function"==typeof f?u(Function.call,f):f,m&&((v.virtual||(v.virtual={}))[c]=f,e&s.R&&g&&!g[c]&&a(g,c,f)))};s.F=1,s.G=2,s.S=4,s.P=8,s.B=16,s.W=32,s.U=64,s.R=128,e.exports=s},function(e,t){var n={}.hasOwnProperty;e.exports=function(e,t){return n.call(e,t)}},function(e,t,n){var r=n(39),o=n(44);e.exports=n(4)?function(e,t,n){return r.f(e,t,o(1,n))}:function(e,t,n){return e[t]=n,e}},function(e,t,n){e.exports=!n(4)&&!n(5)(function(){return 7!=Object.defineProperty(n(32)("div"),"a",{get:function(){return 7}}).a})},function(e,t,n){"use strict";var r=n(42),o=n(40),u=n(43),a=n(49),i=n(11),s=Object.assign;e.exports=!s||n(5)(function(){var e={},t={},n=Symbol(),r="abcdefghijklmnopqrst";return e[n]=7,r.split("").forEach(function(e){t[e]=e}),7!=s({},e)[n]||Object.keys(s({},t)).join("")!=r})?function(e,t){for(var n=a(e),s=arguments.length,c=1,l=o.f,f=u.f;s>c;)for(var d,p=i(arguments[c++]),h=l?r(p).concat(l(p)):r(p),m=h.length,x=0;m>x;)f.call(p,d=h[x++])&&(n[d]=p[d]);return n}:s},function(e,t,n){var r=n(28),o=n(37),u=n(50),a=Object.defineProperty;t.f=n(4)?Object.defineProperty:function(e,t,n){if(r(e),t=u(t,!0),r(n),o)try{return a(e,t,n)}catch(e){}if("get"in n||"set"in n)throw TypeError("Accessors not supported!");return"value"in n&&(e[t]=n.value),e}},function(e,t){t.f=Object.getOwnPropertySymbols},function(e,t,n){var r=n(35),o=n(13),u=n(29)(!1),a=n(45)("IE_PROTO");e.exports=function(e,t){var n,i=o(e),s=0,c=[];for(n in i)n!=a&&r(i,n)&&c.push(n);for(;t.length>s;)r(i,n=t[s++])&&(~u(c,n)||c.push(n));return c}},function(e,t,n){var r=n(41),o=n(33);e.exports=Object.keys||function(e){return r(e,o)}},function(e,t){t.f={}.propertyIsEnumerable},function(e,t){e.exports=function(e,t){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}}},function(e,t,n){var r=n(46)("keys"),o=n(51);e.exports=function(e){return r[e]||(r[e]=o(e))}},function(e,t,n){var r=n(6),o="__core-js_shared__",u=r[o]||(r[o]={});e.exports=function(e){return u[e]||(u[e]={})}},function(e,t,n){var r=n(12),o=Math.max,u=Math.min;e.exports=function(e,t){return e=r(e),e<0?o(e+t,0):u(e,t)}},function(e,t,n){var r=n(12),o=Math.min;e.exports=function(e){return e>0?o(r(e),9007199254740991):0}},function(e,t,n){var r=n(10);e.exports=function(e){return Object(r(e))}},function(e,t,n){var r=n(7);e.exports=function(e,t){if(!r(e))return e;var n,o;if(t&&"function"==typeof(n=e.toString)&&!r(o=n.call(e)))return o;if("function"==typeof(n=e.valueOf)&&!r(o=n.call(e)))return o;if(!t&&"function"==typeof(n=e.toString)&&!r(o=n.call(e)))return o;throw TypeError("Can't convert object to primitive value")}},function(e,t){var n=0,r=Math.random();e.exports=function(e){return"Symbol(".concat(void 0===e?"":e,")_",(++n+r).toString(36))}},function(e,t,n){var r=n(34);r(r.S+r.F,"Object",{assign:n(38)})},function(e,t){e.exports={title:"Slack MFA",name:"auth0-slack-mfa",version:"0.0.1",author:"auth0",description:"This extension gives the ability to add multifactor authentication using Slack.",type:"application",useHashName:!1,initialUrlPath:"/admins/login",uninstallConfirmMessage:"Do you really want to uninstall this extension?",repository:"https://github.com/auth0-extensions/auth0-slack-mfa",keywords:["auth0","extension","slack","mfa"],auth0:{createClient:!0,onInstallPath:"/.extensions/on-install",onUninstallPath:"/.extensions/on-uninstall",scopes:"read:clients delete:clients read:rules create:rules update:rules delete:rules"},secrets:{SLACK_API_TOKEN:{example:"Slack API Token",description:"Your Slack API token.",required:!0},MONGO_CONNECTION_STRING:{example:"Slack API Token",description:"Your MongoDB connection string.",required:!0},SIGNING_SECRET:{example:"mZj2fpwpwbbiepepBofeappfoe9929294949",description:"The secret used to sign the JWT's used by this extension.",required:!0,type:"password"}}}},function(e,t){e.exports=require("body-parser")},function(e,t){e.exports=require("lodash@3.10.1")},function(e,t){e.exports=require("morgan")},function(e,t){e.exports=require("winston")}]);